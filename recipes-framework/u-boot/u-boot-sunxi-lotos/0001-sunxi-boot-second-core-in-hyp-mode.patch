From 87845f6ed1dbf581d7e13a77c903185487982a68 Mon Sep 17 00:00:00 2001
From: Alexander Smirnov <asmirnov@ilbers.de>
Date: Wed, 31 Dec 2014 14:22:21 +0400
Subject: [PATCH 1/2] sunxi: boot second core in hyp mode

Boot secondary CPU core in hypervisor mode.

Signed-off-by: Alexander Smirnov <asmirnov@ilbers.de>
---
 arch/arm/cpu/armv7/sunxi/smp.c | 25 ++++++++++++++++++-------
 boards.cfg                     |  2 +-
 2 files changed, 19 insertions(+), 8 deletions(-)

diff --git a/arch/arm/cpu/armv7/sunxi/smp.c b/arch/arm/cpu/armv7/sunxi/smp.c
index 2d32de4..ca45083 100644
--- a/arch/arm/cpu/armv7/sunxi/smp.c
+++ b/arch/arm/cpu/armv7/sunxi/smp.c
@@ -19,17 +19,28 @@
 
 static void secondary_pen(void)
 {
-	struct sunxi_cpucfg *cpucfg = (struct sunxi_cpucfg *)SUNXI_CPUCFG_BASE;
-
 	while (1) {
-		__asm__ __volatile__("wfe" ::: "memory");
 
-		unsigned long boot_addr = readl(&cpucfg->boot_addr);
+		__asm__ __volatile__(
+			"wfe	\n"
+			::: "memory"
+		);
+
+		volatile struct sunxi_cpucfg *cpucfg = (struct sunxi_cpucfg *)SUNXI_CPUCFG_BASE;
+
+		__asm__ __volatile__(
+			"mrc	p15, 0, r0, c1, c0, 1	\n"
+			"orr	r0, r0, #0x40		\n"
+			"mcr	p15, 0, r0, c1, c0, 1	\n"
+			"isb				\n"
+			"bl	_nonsec_init		\n"
+			"bl      psci_arch_init \n"
+			::: "memory");
 
 		__asm__ __volatile__(
-			"mov	r14, %0	\n"
-			"bx	r14	\n"
-			: : "r" (boot_addr)
+			"mov     r0, %0 \n"
+			"b       _do_nonsec_entry \n"
+			: : "r" (readl(&cpucfg->boot_addr))
 		);
 	};
 }
diff --git a/boards.cfg b/boards.cfg
index 0323aa7..d3b642b 100644
--- a/boards.cfg
+++ b/boards.cfg
@@ -387,7 +387,7 @@ Active  arm         armv7          sunxi       -               sunxi
 Active  arm         armv7          sunxi       -               sunxi               Auxtek-T003                          sun5i:AUXTEK_T003,SPL,AXP152_POWER,STATUSLED=34                                                                                   -
 Active  arm         armv7          sunxi       -               sunxi               Auxtek-T004                          sun5i:AUXTEK_T004,SPL,AXP152_POWER,STATUSLED=34                                                                                   -
 Active  arm         armv7          sunxi       -               sunxi               ba10_tv_box                          sun4i:BA10_TV_BOX,SPL,SUNXI_EMAC                                                                                                  -
-Active  arm         armv7          sunxi       -               sunxi               Bananapi                             sun7i:BANANAPI,SPL,SUNXI_GMAC,RGMII,MACPWR=SUNXI_GPH(23),STATUSLED=244,STATUSLED1=245,FAST_MBUS                                   -
+Active  arm         armv7          sunxi       -               sunxi               Bananapi                             sun7i:BANANAPI,SPL,SUNXI_GMAC,RGMII,SYS_SECONDARY_ON,MACPWR=SUNXI_GPH(23),STATUSLED=244,STATUSLED1=245,FAST_MBUS                                   -
 Active  arm         armv7          sunxi       -               sunxi               Bananapi_FEL                         sun7i:BANANAPI,SPL_FEL,SUNXI_GMAC,RGMII,MACPWR=SUNXI_GPH(23),STATUSLED=244,STATUSLED1=245,FAST_MBUS                               -
 Active  arm         armv7          sunxi       -               sunxi               Coby_MID7042                         sun4i:COBY_MID7042,SPL                                                                                                            -
 Active  arm         armv7          sunxi       -               sunxi               Coby_MID8042                         sun4i:COBY_MID8042,SPL                                                                                                            -
-- 
1.9.3

