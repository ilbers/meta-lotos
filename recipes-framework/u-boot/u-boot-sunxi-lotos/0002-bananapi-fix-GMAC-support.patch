From 733a8ce0d3628c1a889c6331617fe1d5bf4045fd Mon Sep 17 00:00:00 2001
From: Alexander Smirnov <asmirnov@ilbers.de>
Date: Fri, 16 Jan 2015 12:11:00 +0400
Subject: [PATCH 2/2] bananapi: fix GMAC support

Fix networking support on bananapi board.

Signed-off-by: Alexander Smirnov <asmirnov@ilbers.de>
---
 arch/arm/cpu/armv7/sunxi/board.c |  7 ++++++-
 board/sunxi/board.c              | 28 ++++++++++++++++++++++++++++
 board/sunxi/gmac.c               | 10 ++++++++++
 3 files changed, 44 insertions(+), 1 deletion(-)

diff --git a/arch/arm/cpu/armv7/sunxi/board.c b/arch/arm/cpu/armv7/sunxi/board.c
index 9e5aec2..ac94a1f 100644
--- a/arch/arm/cpu/armv7/sunxi/board.c
+++ b/arch/arm/cpu/armv7/sunxi/board.c
@@ -138,7 +138,12 @@ void enable_caches(void)
  */
 int cpu_eth_init(bd_t *bis)
 {
-	int rc;
+	__maybe_unused int rc;
+
+#ifdef CONFIG_MACPWR
+	gpio_direction_output(CONFIG_MACPWR, 1);
+	mdelay(200);
+#endif
 
 #ifdef CONFIG_SUNXI_EMAC
 	rc = sunxi_emac_initialize(bis);
diff --git a/board/sunxi/board.c b/board/sunxi/board.c
index 0f37d8d..4fe6176 100644
--- a/board/sunxi/board.c
+++ b/board/sunxi/board.c
@@ -233,6 +233,34 @@ int misc_init_r(void)
 			eth_setenv_enetaddr("ethaddr", mac_addr);
 		}
 	}
+#if defined(CONFIG_BANANAPI) || defined(CONFIG_BANANAPRO)
+	else {
+		unsigned char *p;
+		p = getenv("ethaddr");
+		uint32_t reg_val = readl(SUNXI_SID_BASE);
+
+		if (reg_val) {
+			uint8_t mac_addr[6];
+			int i;
+
+			mac_addr[0] = 0x02; /* Non OUI / registered MAC address */
+			mac_addr[1] = (reg_val >>  0) & 0xff;
+			reg_val = readl(SUNXI_SID_BASE + 0x0c);
+			mac_addr[2] = (reg_val >> 24) & 0xff;
+			mac_addr[3] = (reg_val >> 16) & 0xff;
+			mac_addr[4] = (reg_val >>  8) & 0xff;
+			mac_addr[5] = (reg_val >>  0) & 0xff;
+
+			for(i = 0; i < 6; i ++)
+			{
+				if(mac_addr[i] != *(p + i)){
+					eth_setenv_enetaddr("ethaddr", mac_addr);
+					break;
+				}
+			}
+		}
+	}
+#endif
 
 	return 0;
 }
diff --git a/board/sunxi/gmac.c b/board/sunxi/gmac.c
index e7ff952..c99a722 100644
--- a/board/sunxi/gmac.c
+++ b/board/sunxi/gmac.c
@@ -24,6 +24,16 @@ int sunxi_gmac_initialize(bd_t *bis)
 		CCM_GMAC_CTRL_GPIT_MII);
 #endif
 
+
+	/*
+	 * HdG: this is necessary to get GMAC to work reliable on the
+	 * Bananapi. We don't know what these undocumented bits do, so this
+	 * is a Bananapi specific hack for now.
+	 */
+#if defined(CONFIG_BANANAPI) || defined(CONFIG_BANANAPRO)
+	setbits_le32(&ccm->gmac_clk_cfg, 0x3 << 10);
+#endif
+
 	/* Configure pin mux settings for GMAC */
 	for (pin = SUNXI_GPA(0); pin <= SUNXI_GPA(16); pin++) {
 #ifdef CONFIG_RGMII
-- 
1.9.3

